<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Termin-Übersicht (edu-event-wall)</title>
  <style>
    :root{
      --primary-color:#2a73c2;
      --secondary-color:#f5a623;
      --background-color:#f4f7f6;
      --font-color:#333;
      --white:#fff;
      --tile-shadow:0 5px 15px rgba(0,0,0,.2);
      --date-red:#d9534f;
      --muted:#6b7280;
      --chip-bg:#eef2ff;
      --chip-border:#c7d2fe;
    }
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background-color:var(--background-color);
      color:var(--font-color);
      margin:0;
      padding:20px;
    }
    h1{
      text-align:center;
      color:var(--primary-color);
      margin:0 0 10px 0;
    }
    .subhead{
      text-align:center;
      color:var(--muted);
      margin:0 0 20px 0;
      font-size:.95rem;
    }

    /* FILTER TOOLBAR */
    .filter-toolbar{
      max-width:1600px;
      margin:0 auto 24px auto;
      background:var(--white);
      border-radius:12px;
      box-shadow:var(--tile-shadow);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .field{
      position:relative;
      display:flex;
      align-items:center;
      gap:8px;
      background:#fafafa;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:8px 10px;
    }
    .field label{
      font-size:.85rem;
      color:#374151;
      white-space:nowrap;
    }
    .field input[type="text"]{
      border:none;
      outline:none;
      background:transparent;
      min-width:200px;
      flex:1;
      font-size:1rem;
    }
    .field select{
      border:none;
      outline:none;
      background:transparent;
      font-size:1rem;
    }
    .btn{
      background:var(--primary-color);
      color:var(--white);
      border:none;
      border-radius:10px;
      padding:10px 14px;
      cursor:pointer;
    }
    .btn.ghost{
      background:#eef2f7;
      color:#334155;
    }
    .result-info{
      margin-left:auto;
      color:#374151;
      font-size:.9rem;
    }
    .selected-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip-bg);
      border:1px solid var(--chip-border);
      font-size:.85rem;
    }
    .chip button{
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:bold;
      line-height:1;
      padding:0 2px;
    }

    /* TAG SUGGEST BOX */
    .tagbox{
      position:relative;
      min-width:280px;
    }
    .tagbox .tag-input{
      min-width:160px;
      flex:1;
    }
    .suggest{
      position:absolute;
      top:100%; left:0; right:0;
      background:var(--white);
      border:1px solid #e5e7eb;
      border-top:none;
      border-radius:0 0 10px 10px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      max-height:240px;
      overflow:auto;
      z-index:20;
      display:none;
    }
    .suggest.open{display:block;}
    .suggest button{
      width:100%;
      text-align:left;
      padding:8px 10px;
      background:var(--white);
      border:none;
      cursor:pointer;
    }
    .suggest button:hover{background:#f3f4f6;}
    .suggest .count{color:#6b7280; font-size:.8rem;}

    /* GRID */
    #edu-event-wall{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(320px,1fr));
      gap:30px;
      max-width:1600px;
      margin:0 auto;
    }
    .event-tile{
      background:var(--white);
      border-radius:8px;
      box-shadow:var(--tile-shadow);
      overflow:hidden;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
      display:flex;
      flex-direction:column;
    }
    .event-tile:hover{
      transform:translateY(-5px);
      box-shadow:0 10px 20px rgba(0,0,0,.25);
    }
    .tile-header{
      position:relative;
      height:200px;
      background-size:cover;
      background-position:center;
      color:var(--white);
    }
    .tile-header.no-image{
      background:linear-gradient(45deg,#4e54c8,#8f94fb);
    }
    .tile-overlay{
      position:absolute;
      top:0; left:0; width:100%;
      padding:15px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .date-bubble{
      background:var(--white);
      border-radius:4px;
      text-align:center;
      box-shadow:6px 6px 9px rgba(0,0,0,.4);
      font-weight:bold;
      line-height:1.1;
      flex-shrink:0;
      overflow:hidden;
      display:flex; flex-direction:column;
      min-width:4.5rem;
    }
    .date-bubble-year{background:var(--date-red); color:var(--white); padding:3px 8px; font-size:.9em;}
    .date-bubble-day{color:var(--font-color); padding:0 10px; font-size:2.2em; line-height:1.2;}
    .date-bubble-month{color:#555; padding-bottom:5px; font-size:1.1em; text-transform:uppercase;}
    .tile-tags{
      display:flex; flex-direction:column; align-items:flex-end; gap:6px;
    }
    .tile-tags button{
      background-color:rgba(42,115,194,.9);
      color:var(--white);
      padding:5px 10px;
      border-radius:4px;
      font-size:.85em;
      border:none;
      cursor:pointer;
    }

    .tile-body{background:var(--primary-color); color:var(--white); padding:20px; flex-grow:1;}
    .tile-body a{color:var(--white); text-decoration:none;}
    .tile-title{margin:0 0 15px 0; line-height:1.3;}
    .tile-meta{
      display:grid;
      grid-template-rows:1.5rem 1.5rem auto 1fr;
      height:12vh;
      align-items:self-end;
    }
    .tile-meta p{margin:8px 0; display:flex; align-items:flex-start; gap:10px; font-size:.95em;}
    .tile-meta .summary{vertical-align:baseline;}
    .tile-meta svg{width:18px; height:18px; fill:var(--white); flex-shrink:0; margin-top:2px;}

    #loader,#no-events{ text-align:center; padding:40px; font-size:1.2em; grid-column:1 / -1; }

    /* MODAL */
    .modal{ display:none; position:fixed; z-index:1000; inset:0; overflow:auto; background:rgba(0,0,0,.5); animation:fadeIn .3s;}
    .modal-content{ background:var(--white); margin:5% auto; padding:30px; border-radius:8px; width:90%; max-width:680px; position:relative; box-shadow:0 5px 15px rgba(0,0,0,.3); animation:slideIn .3s;}
    .close-button{ color:#aaa; font-size:28px; font-weight:bold; position:absolute; top:10px; right:20px; cursor:pointer;}
    #modal-image-container{ width:100%; margin-bottom:20px; text-align:center;}
    #modal-image-container img{ max-width:100%; max-height:250px; height:auto; border-radius:8px; object-fit:cover;}
    #modal-title{ margin-top:0; color:var(--primary-color);}
    #modal-date{ font-weight:500; color:#555; margin-bottom:20px;}
    #modal-details strong{ display:inline-block; min-width:80px; color:var(--primary-color);}
    #modal-details p{ margin:8px 0;}
    #modal-content-html{ margin-top:20px; padding-top:20px; border-top:1px solid #e5e7eb;}
    #modal-content-html p{ line-height:1.6;}
    #modal-tags button{ display:inline-block; background:var(--secondary-color); color:var(--white); padding:3px 8px; border-radius:12px; font-size:.8em; margin-right:5px; margin-bottom:5px; border:none; cursor:pointer;}

    @keyframes fadeIn{from{opacity:0} to{opacity:1}}
    @keyframes slideIn{from{transform:translateY(-50px)} to{transform:translateY(0)}}
  </style>
</head>
<body>
  <h1>Aktuelle Termine</h1>
  <p class="subhead">Klicke auf Tags oder nutze die Filterleiste, um die Ansicht einzugrenzen.</p>

  <!-- FILTER TOOLBAR -->
  <section class="filter-toolbar" aria-label="Terminfilter">
    <div class="filter-row">
      <!-- Tag Selector -->
      <div class="field tagbox" style="flex:1 1 360px;">
        <label for="tag-input">Tags</label>
        <input id="tag-input" class="tag-input" type="text" placeholder="Tag suchen & Enter zum Hinzufügen" autocomplete="off" aria-describedby="tag-help" />
        <div id="tag-suggest" class="suggest" role="listbox" aria-label="Tag-Vorschläge"></div>
      </div>

      <!-- Text Search -->
      <div class="field" style="flex:1 1 280px;">
        <label for="search-input">Suche</label>
        <input id="search-input" type="text" placeholder="Titel & Tags durchsuchen …" />
      </div>

      <!-- Month Dropdown -->
      <div class="field" style="flex:0 0 220px;">
        <label for="month-select">Monat</label>
        <select id="month-select" aria-label="Monat wählen">
          <option value="">Alle Monate</option>
        </select>
      </div>

      <!-- Reset / Result -->
      <button id="reset-filters" class="btn ghost" title="Alle Filter zurücksetzen">Zurücksetzen</button>
      <div class="result-info" id="result-info">0 Treffer</div>
    </div>

    <div class="filter-row">
      <div id="selected-tags" class="selected-tags" aria-live="polite"></div>
    </div>
  </section>

  <div id="edu-event-wall">
    <div id="loader">Lade Termine...</div>
  </div>

  <!-- MODAL -->
  <div id="event-modal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content">
      <button id="close-modal" class="close-button" aria-label="Schließen">×</button>
      <div id="modal-image-container"></div>
      <h2 id="modal-title"></h2>
      <p id="modal-date"></p>
      <div id="modal-details">
        <p><strong>Zusammenfassung:</strong> <span id="modal-summary"></span></p>
        <p><strong>Ort:</strong> <span id="modal-location"></span></p>
        <p><strong>Tags:</strong> <span id="modal-tags"></span></p>
      </div>
      <div id="modal-content-html"></div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const endpoint = 'https://n8n.rpi-virtuell.de/webhook/nostre_termine';

    // Elements
    const eventWallEl = document.getElementById('edu-event-wall');
    const loaderEl = document.getElementById('loader');
    const resultInfoEl = document.getElementById('result-info');

    const tagInput = document.getElementById('tag-input');
    const tagSuggest = document.getElementById('tag-suggest');
    const selectedTagsEl = document.getElementById('selected-tags');

    const searchInput = document.getElementById('search-input');
    const monthSelect = document.getElementById('month-select');
    const resetBtn = document.getElementById('reset-filters');

    const modal = document.getElementById('event-modal');
    const closeModalBtn = document.getElementById('close-modal');

    // Data
    let allEvents = [];
    let filteredEvents = [];
    const state = {
      selectedTags: new Set(),
      searchQuery: '',
      monthKey: ''
    };

    const toMonthKey = (date) => {
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      return y + '-' + m;
    };
    const monthKeyToLabel = (key) => {
      const [y,m] = key.split('-').map(Number);
      const date = new Date(y, m-1, 1);
      return new Intl.DateTimeFormat('de-DE', { month:'long', year:'numeric' }).format(date);
    };
    const formatEventTimeSpan = (start, end) => {
      const isSameDay = start.toDateString() === end.toDateString();
      if (isSameDay) {
        const dateFormat = new Intl.DateTimeFormat('de-DE', { day:'numeric', month:'long', year:'numeric' });
        const startTimeFormat = new Intl.DateTimeFormat('de-DE', { hour:'2-digit', minute:'2-digit' });
        const endTimeFormat = new Intl.DateTimeFormat('de-DE', { hour:'2-digit', minute:'2-digit' });
        return `${dateFormat.format(start)}, ${startTimeFormat.format(start)} - ${endTimeFormat.format(end)} Uhr`;
      } else {
        const fullFormat = new Intl.DateTimeFormat('de-DE', { day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' });
        return `${fullFormat.format(start)} Uhr - ${fullFormat.format(end)} Uhr`;
      }
    };

    // Icons
    const locationIcon = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
    const clockIcon = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>`;

    // Helpers
    const normalizeTags = (raw) => {
      const arr = Array.isArray(raw) ? raw : (raw ? String(raw).split(',') : []);
      return arr.map(t => t.trim()).filter(Boolean);
    };

    const buildEvent = (event) => {
      const start = new Date(event.starts || event.start || event.begin || event.date);
      const end = new Date(event.ends || event.end || event.finish || start);
      const tagsArr = normalizeTags(event.tags);
      return {
        ...event,
        start, end,
        tagsArr,
        tagsLower: tagsArr.map(t => t.toLowerCase()),
        monthKey: toMonthKey(start)
      };
    };

    const getAllTagsWithCounts = (events) => {
      const map = new Map();
      events.forEach(e => e.tagsArr.forEach(tag => {
        const key = tag.toLowerCase();
        const entry = map.get(key) || { label: tag, count: 0 };
        // prefer the longest-cased label seen (often the nicest)
        if (tag.length > entry.label.length) entry.label = tag;
        entry.count++;
        map.set(key, entry);
      }));
      return Array.from(map.entries())
        .sort((a,b) => b[1].count - a[1].count) // by freq desc
        .map(([key, val]) => ({ key, label: val.label, count: val.count }));
    };

    const getAllMonths = (events) => {
      const set = new Set(events.map(e => e.monthKey));
      return Array.from(set).sort();
    };

    // Fetch
    const fetchEvents = async () => {
      try {
        const res = await fetch(endpoint);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        let list = [];
        if (Array.isArray(data) && data.length > 0 && data[0].nostrfeed) {
          list = data[0].nostrfeed.map(buildEvent).sort((a,b) => a.start - b.start);
        }
        allEvents = list;
        filteredEvents = list.slice();
      } catch(err) {
        console.error('Fehler beim Abruf:', err);
        eventWallEl.innerHTML = `<div id="no-events" style="color:red;">Fehler beim Laden der Termine.</div>`;
      }
    };

    // Rendering
    const renderEventWall = (list) => {
      eventWallEl.innerHTML = '';
      if (!list || list.length === 0) {
        eventWallEl.innerHTML = `<div id="no-events">Keine Treffer für die gewählten Filter.</div>`;
        resultInfoEl.textContent = '0 Treffer';
        return;
      }
      resultInfoEl.textContent = list.length + (list.length === 1 ? ' Treffer' : ' Treffer');
      list.forEach(event => {
        const tile = document.createElement('div');
        tile.className = 'event-tile';
        tile.addEventListener('click', () => showEventModal(event));

        const day = event.start.getDate();
        const month = new Intl.DateTimeFormat('de-DE', { month:'short' }).format(event.start).replace('.','');
        const year = event.start.getFullYear();
        const timeSpan = formatEventTimeSpan(event.start, event.end);

        const tags = event.tagsArr.slice(0,3);
        const tagsHTML = tags.map(tag => `<button class="tag-badge" data-tag="${encodeURIComponent(tag)}" title="Nach Tag filtern">${tag}</button>`).join('');

        tile.innerHTML = `
          <div class="tile-header ${event.image ? '' : 'no-image'}" style="background-image:url('${event.image || ''}')">
            <div class="tile-overlay">
              <div class="date-bubble">
                <div class="date-bubble-year">${year}</div>
                <div class="date-bubble-day">${day}</div>
                <div class="date-bubble-month">${month}</div>
              </div>
              <div class="tile-tags">${tagsHTML}</div>
            </div>
          </div>
          <div class="tile-body">
            <h3 class="tile-title">${event.title}</h3>
            <div class="tile-meta">
              <p>${clockIcon}<span>${timeSpan}</span></p>
              ${event.location ? `<p>${locationIcon}<span>${event.location}</span></p>` : ''}
              <div class="ghost"></div>
              ${event.summary ? `<div class="summary">${event.summary}</div>` : ''}
            </div>
          </div>
        `;
        // Make header tags clickable without opening modal
        tile.querySelectorAll('.tag-badge').forEach(btn => {
          btn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const tag = decodeURIComponent(btn.getAttribute('data-tag'));
            addTagToState(tag);
          });
        });

        eventWallEl.appendChild(tile);
      });
    };

    const updateResultInfo = () => {
      resultInfoEl.textContent = filteredEvents.length + (filteredEvents.length === 1 ? ' Treffer' : ' Treffer');
    };

    // Modal
    const showEventModal = (event) => {
      const modalImageContainer = document.getElementById('modal-image-container');
      modalImageContainer.innerHTML = '';
      if (event.image) {
        const img = document.createElement('img');
        img.src = event.image;
        img.alt = `Bild für ${event.title}`;
        modalImageContainer.appendChild(img);
        modalImageContainer.style.display = 'block';
      } else {
        modalImageContainer.style.display = 'none';
      }
      document.getElementById('modal-title').textContent = event.title;
      document.getElementById('modal-summary').textContent = event.summary || 'Keine Zusammenfassung vorhanden.';
      document.getElementById('modal-location').innerHTML =
        event.location && event.location.startsWith('http')
          ? `<a href="${event.location}" target="_blank" rel="noopener noreferrer">${event.location}</a>`
          : (event.location || 'Kein Ort angegeben.');
      document.getElementById('modal-date').textContent = formatEventTimeSpan(event.start, event.end);

      const tagsContainer = document.getElementById('modal-tags');
      tagsContainer.innerHTML = '';
      if (event.tagsArr.length) {
        event.tagsArr.forEach(tag => {
          const b = document.createElement('button');
          b.textContent = tag;
          b.title = 'Nach Tag filtern';
          b.addEventListener('click', (e) => { e.stopPropagation(); addTagToState(tag); });
          tagsContainer.appendChild(b);
        });
      } else {
        const span = document.createElement('span');
        span.textContent = 'Keine';
        tagsContainer.appendChild(span);
      }
      document.getElementById('modal-content-html').innerHTML = event.content || '';
      modal.style.display = 'block';
    };
    closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

    // Filtering
    const applyFilters = () => {
      const q = state.searchQuery.trim().toLowerCase();
      filteredEvents = allEvents.filter(e => {
        // Tag filter (ANY-of selected tags)
        const tagOK = state.selectedTags.size === 0
          ? true
          : Array.from(state.selectedTags).some(t => e.tagsLower.includes(t));
        // Search across title and tags
        const searchOK = !q
          ? true
          : (e.title?.toLowerCase().includes(q) || e.tagsLower.some(t => t.includes(q)));
        // Month
        const monthOK = !state.monthKey || e.monthKey === state.monthKey;
        return tagOK && searchOK && monthOK;
      });
      renderEventWall(filteredEvents);
      renderSelectedTagsChips();
    };

    const addTagToState = (tag) => {
      const key = tag.toLowerCase();
      if (!key) return;
      state.selectedTags.add(key);
      tagInput.value = '';
      applyFilters();
      // Keep focus on tag input to encourage further tags
      tagInput.focus();
    };
    const removeTagFromState = (key) => {
      state.selectedTags.delete(key);
      applyFilters();
    };

    // UI: Selected tag chips
    const renderSelectedTagsChips = () => {
      selectedTagsEl.innerHTML = '';
      if (state.selectedTags.size === 0) return;
      const all = getAllTagsWithCounts(allEvents);
      const labelFor = (k) => (all.find(x => x.key === k)?.label) || k;
      state.selectedTags.forEach(k => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span>${labelFor(k)}</span>`;
        const btn = document.createElement('button');
        btn.setAttribute('aria-label', 'Tag entfernen');
        btn.textContent = '×';
        btn.addEventListener('click', () => removeTagFromState(k));
        chip.appendChild(btn);
        selectedTagsEl.appendChild(chip);
      });
    };

    // Tag suggest dropdown
    const buildTagSuggest = () => {
      const tags = getAllTagsWithCounts(allEvents);
      const renderList = (filter='') => {
        const f = filter.trim().toLowerCase();
        const out = (f
          ? tags.filter(t => t.label.toLowerCase().includes(f) || t.key.includes(f))
          : tags).slice(0, 200); // safety cap
        tagSuggest.innerHTML = out.map(t => 
          `<button type="button" data-key="${t.key}">${t.label} <span class="count">(${t.count})</span></button>`
        ).join('');
        tagSuggest.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const key = btn.getAttribute('data-key');
            addTagToState(tags.find(x => x.key === key)?.label || key);
            tagSuggest.classList.remove('open');
          });
        });
      };
      renderList();
      // interactions
      tagInput.addEventListener('focus', () => tagSuggest.classList.add('open'));
      tagInput.addEventListener('blur', () => {
        setTimeout(() => tagSuggest.classList.remove('open'), 150);
      });
      tagInput.addEventListener('input', (e) => {
        tagSuggest.classList.add('open');
        renderList(tagInput.value);
        // live-filter also applies to results, but we keep it for tag suggest only
      });
      tagInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const val = tagInput.value.trim();
          if (val) addTagToState(val);
          tagSuggest.classList.remove('open');
        }
      });
    };

    // Month dropdown
    const buildMonthSelect = () => {
      const months = getAllMonths(allEvents);
      months.forEach(key => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = monthKeyToLabel(key);
        monthSelect.appendChild(opt);
      });
    };

    // Wire up filter inputs
    searchInput.addEventListener('input', () => {
      state.searchQuery = searchInput.value;
      applyFilters(); // reacts on keydown via input event
    });
    monthSelect.addEventListener('change', () => {
      state.monthKey = monthSelect.value;
      applyFilters();
    });
    resetBtn.addEventListener('click', () => {
      state.selectedTags.clear();
      state.searchQuery = '';
      state.monthKey = '';
      searchInput.value = '';
      monthSelect.value = '';
      tagInput.value = '';
      applyFilters();
    });

    // INIT
    const init = async () => {
      await fetchEvents();
      if (loaderEl) loaderEl.style.display = 'none';
      // Build controls
      buildTagSuggest();
      buildMonthSelect();
      // Initial render
      applyFilters();
    };

    init();
  });
  </script>
</body>
</html>
